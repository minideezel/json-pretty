<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Pretty - Advanced JSON Viewer & JSONata Processor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsonata@2.0.3/jsonata.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <style>
        .json-key { color: #9cdcfe; }
        .json-string { color: #ce9178; }
        .json-number { color: #b5cea8; }
        .json-boolean { color: #569cd6; }
        .json-null { color: #808080; }
        .json-bracket { color: #ffd700; }
        
        .tree-node { 
            padding-left: 1.5rem;
            border-left: 1px solid #374151;
        }
        .tree-toggle {
            cursor: pointer;
            user-select: none;
        }
        .tree-toggle:hover {
            background-color: #374151;
            border-radius: 2px;
        }
        .collapsed > .tree-children {
            display: none;
        }
        .collapsed > .tree-toggle .arrow {
            transform: rotate(-90deg);
        }
        .arrow {
            display: inline-block;
            transition: transform 0.15s ease;
        }
        .highlight {
            background-color: #fbbf24;
            color: #000;
            border-radius: 2px;
            padding: 0 2px;
        }
        .CodeMirror {
            height: 120px;
            font-size: 14px;
            border-radius: 0.5rem;
        }
        .copy-btn {
            opacity: 0;
            transition: opacity 0.15s ease;
        }
        .tree-line:hover .copy-btn {
            opacity: 1;
        }
        .drop-zone.drag-over {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-full">
        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-blue-400 mb-2">JSON Pretty</h1>
            <p class="text-gray-400">Advanced JSON Viewer with live JSONata processing</p>
        </header>

        <!-- File Upload Section -->
        <div id="dropZone" class="drop-zone border-2 border-dashed border-gray-600 rounded-xl p-8 mb-6 text-center transition-all duration-200 cursor-pointer hover:border-blue-500">
            <input type="file" id="fileInput" accept=".json,application/json" class="hidden">
            <div class="flex flex-col items-center gap-3">
                <svg class="w-12 h-12 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="text-gray-400">Drag & drop a JSON file here, or <span class="text-blue-400 hover:underline">click to browse</span></p>
                <p class="text-sm text-gray-500">Supports .json files</p>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded-lg mb-6">
            <div class="flex items-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
                <span id="errorText"></span>
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="hidden">
            <!-- Controls Bar -->
            <div class="flex flex-wrap gap-4 mb-4 items-center">
                <div class="flex items-center gap-2">
                    <label class="text-sm text-gray-400">Search:</label>
                    <input type="text" id="searchInput" placeholder="Search keys or values..." 
                        class="bg-gray-800 border border-gray-600 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:border-blue-500 w-64">
                    <span id="searchCount" class="text-sm text-gray-500"></span>
                </div>
                <button id="expandAllBtn" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition-colors">
                    Expand All
                </button>
                <button id="collapseAllBtn" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition-colors">
                    Collapse All
                </button>
                <button id="clearBtn" class="px-3 py-1.5 bg-red-700 hover:bg-red-600 rounded-lg text-sm transition-colors ml-auto">
                    Clear
                </button>
            </div>

            <!-- Three Panel Layout -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <!-- JSON Tree View Panel -->
                <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
                    <div class="bg-gray-750 px-4 py-2 border-b border-gray-700 flex items-center justify-between">
                        <h2 class="font-semibold text-gray-200">JSON Input</h2>
                        <span id="jsonStats" class="text-xs text-gray-500"></span>
                    </div>
                    <div id="jsonTree" class="p-4 overflow-auto font-mono text-sm" style="max-height: 600px;"></div>
                </div>

                <!-- JSONata Query Panel -->
                <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden flex flex-col">
                    <div class="bg-gray-750 px-4 py-2 border-b border-gray-700 flex items-center justify-between">
                        <h2 class="font-semibold text-gray-200">JSONata Query</h2>
                        <button id="cheatSheetBtn" class="text-xs text-blue-400 hover:text-blue-300 transition-colors">
                            Cheat Sheet
                        </button>
                    </div>
                    <div class="p-4 flex-grow flex flex-col">
                        <textarea id="jsonataInput" class="hidden"></textarea>
                        <div id="jsonataEditor" class="flex-grow"></div>
                        <div id="queryError" class="hidden mt-2 text-sm text-red-400 bg-red-900/30 px-3 py-2 rounded"></div>
                    </div>
                    
                    <!-- Cheat Sheet (collapsible) -->
                    <div id="cheatSheet" class="hidden border-t border-gray-700 p-4 bg-gray-850 text-xs overflow-auto" style="max-height: 300px;">
                        <h3 class="font-semibold text-gray-300 mb-3">JSONata Quick Reference</h3>
                        <div class="grid grid-cols-1 gap-3 text-gray-400">
                            <div>
                                <h4 class="text-blue-400 font-medium mb-1">Path Navigation</h4>
                                <code class="block bg-gray-900 px-2 py-1 rounded mb-1">$.fieldName</code>
                                <code class="block bg-gray-900 px-2 py-1 rounded mb-1">$.array[0]</code>
                                <code class="block bg-gray-900 px-2 py-1 rounded mb-1">$.nested.deep.value</code>
                                <code class="block bg-gray-900 px-2 py-1 rounded">$.*</code>
                            </div>
                            <div>
                                <h4 class="text-blue-400 font-medium mb-1">Filtering</h4>
                                <code class="block bg-gray-900 px-2 py-1 rounded mb-1">$.users[age > 21]</code>
                                <code class="block bg-gray-900 px-2 py-1 rounded mb-1">$.items[price >= 10 and price <= 50]</code>
                                <code class="block bg-gray-900 px-2 py-1 rounded">$.products[category = "electronics"]</code>
                            </div>
                            <div>
                                <h4 class="text-blue-400 font-medium mb-1">Mapping & Projection</h4>
                                <code class="block bg-gray-900 px-2 py-1 rounded mb-1">$.users.name</code>
                                <code class="block bg-gray-900 px-2 py-1 rounded mb-1">$.users.{"name": name, "email": email}</code>
                                <code class="block bg-gray-900 px-2 py-1 rounded">$.orders.(price * quantity)</code>
                            </div>
                            <div>
                                <h4 class="text-blue-400 font-medium mb-1">Aggregation Functions</h4>
                                <code class="block bg-gray-900 px-2 py-1 rounded mb-1">$sum($.orders.total)</code>
                                <code class="block bg-gray-900 px-2 py-1 rounded mb-1">$count($.users)</code>
                                <code class="block bg-gray-900 px-2 py-1 rounded mb-1">$average($.scores)</code>
                                <code class="block bg-gray-900 px-2 py-1 rounded">$max($.prices) / $min($.prices)</code>
                            </div>
                            <div>
                                <h4 class="text-blue-400 font-medium mb-1">String Functions</h4>
                                <code class="block bg-gray-900 px-2 py-1 rounded mb-1">$uppercase($.name)</code>
                                <code class="block bg-gray-900 px-2 py-1 rounded mb-1">$lowercase($.title)</code>
                                <code class="block bg-gray-900 px-2 py-1 rounded mb-1">$trim($.text)</code>
                                <code class="block bg-gray-900 px-2 py-1 rounded mb-1">$substring($.str, 0, 5)</code>
                                <code class="block bg-gray-900 px-2 py-1 rounded">$split($.csv, ",")</code>
                            </div>
                            <div>
                                <h4 class="text-blue-400 font-medium mb-1">Array Functions</h4>
                                <code class="block bg-gray-900 px-2 py-1 rounded mb-1">$sort($.items)</code>
                                <code class="block bg-gray-900 px-2 py-1 rounded mb-1">$reverse($.list)</code>
                                <code class="block bg-gray-900 px-2 py-1 rounded mb-1">$distinct($.tags)</code>
                                <code class="block bg-gray-900 px-2 py-1 rounded">$append($.arr1, $.arr2)</code>
                            </div>
                            <div>
                                <h4 class="text-blue-400 font-medium mb-1">Conditional</h4>
                                <code class="block bg-gray-900 px-2 py-1 rounded mb-1">$.age >= 18 ? "Adult" : "Minor"</code>
                                <code class="block bg-gray-900 px-2 py-1 rounded">$exists($.optional) ? $.optional : "default"</code>
                            </div>
                            <div>
                                <h4 class="text-blue-400 font-medium mb-1">Grouping</h4>
                                <code class="block bg-gray-900 px-2 py-1 rounded">$.orders{category: $sum(amount)}</code>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Output Panel -->
                <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
                    <div class="bg-gray-750 px-4 py-2 border-b border-gray-700 flex items-center justify-between">
                        <h2 class="font-semibold text-gray-200">Output</h2>
                        <div class="flex items-center gap-2">
                            <button id="copyOutputBtn" class="text-xs text-gray-400 hover:text-gray-200 transition-colors flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                Copy
                            </button>
                            <button id="downloadOutputBtn" class="text-xs text-gray-400 hover:text-gray-200 transition-colors flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                                Download
                            </button>
                        </div>
                    </div>
                    <div id="outputTree" class="p-4 overflow-auto font-mono text-sm" style="max-height: 600px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300">
        Copied to clipboard!
    </div>

    <script>
        // Global state
        let jsonData = null;
        let jsonataEditor = null;
        let debounceTimer = null;

        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const mainContent = document.getElementById('mainContent');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const jsonTree = document.getElementById('jsonTree');
        const outputTree = document.getElementById('outputTree');
        const searchInput = document.getElementById('searchInput');
        const searchCount = document.getElementById('searchCount');
        const jsonStats = document.getElementById('jsonStats');
        const cheatSheet = document.getElementById('cheatSheet');
        const cheatSheetBtn = document.getElementById('cheatSheetBtn');
        const queryError = document.getElementById('queryError');
        const toast = document.getElementById('toast');

        // Initialize CodeMirror for JSONata
        jsonataEditor = CodeMirror(document.getElementById('jsonataEditor'), {
            mode: 'javascript',
            theme: 'dracula',
            lineNumbers: true,
            placeholder: 'Enter JSONata expression...',
            value: '$',
            lineWrapping: true
        });

        // Event Listeners
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        searchInput.addEventListener('input', () => {
            renderJsonTree(jsonData, jsonTree, searchInput.value);
            updateSearchCount();
        });

        document.getElementById('expandAllBtn').addEventListener('click', () => {
            document.querySelectorAll('.tree-node.collapsed').forEach(node => {
                node.classList.remove('collapsed');
            });
        });

        document.getElementById('collapseAllBtn').addEventListener('click', () => {
            document.querySelectorAll('.tree-node').forEach(node => {
                if (node.querySelector('.tree-children')) {
                    node.classList.add('collapsed');
                }
            });
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            jsonData = null;
            mainContent.classList.add('hidden');
            dropZone.classList.remove('hidden');
            hideError();
            jsonataEditor.setValue('$');
        });

        cheatSheetBtn.addEventListener('click', () => {
            cheatSheet.classList.toggle('hidden');
            cheatSheetBtn.textContent = cheatSheet.classList.contains('hidden') ? 'Cheat Sheet' : 'Hide Cheat Sheet';
        });

        jsonataEditor.on('change', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(executeJsonata, 300);
        });

        document.getElementById('copyOutputBtn').addEventListener('click', () => {
            const output = getOutputData();
            if (output !== undefined) {
                copyToClipboard(JSON.stringify(output, null, 2));
            }
        });

        document.getElementById('downloadOutputBtn').addEventListener('click', () => {
            const output = getOutputData();
            if (output !== undefined) {
                downloadJson(output, 'jsonata-output.json');
            }
        });

        // Functions
        function handleFile(file) {
            if (!file.name.endsWith('.json') && file.type !== 'application/json') {
                showError('Please upload a valid JSON file');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    jsonData = JSON.parse(e.target.result);
                    hideError();
                    dropZone.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    renderJsonTree(jsonData, jsonTree);
                    updateStats(jsonData);
                    executeJsonata();
                } catch (err) {
                    showError(`Invalid JSON: ${err.message}`);
                }
            };
            reader.onerror = () => showError('Error reading file');
            reader.readAsText(file);
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }

        function updateStats(data) {
            const stats = getJsonStats(data);
            jsonStats.textContent = `${stats.keys} keys, ${stats.arrays} arrays, depth: ${stats.depth}`;
        }

        function getJsonStats(data, depth = 0) {
            let stats = { keys: 0, arrays: 0, depth: depth };
            
            if (Array.isArray(data)) {
                stats.arrays++;
                data.forEach(item => {
                    const childStats = getJsonStats(item, depth + 1);
                    stats.keys += childStats.keys;
                    stats.arrays += childStats.arrays;
                    stats.depth = Math.max(stats.depth, childStats.depth);
                });
            } else if (data !== null && typeof data === 'object') {
                const keys = Object.keys(data);
                stats.keys += keys.length;
                keys.forEach(key => {
                    const childStats = getJsonStats(data[key], depth + 1);
                    stats.keys += childStats.keys;
                    stats.arrays += childStats.arrays;
                    stats.depth = Math.max(stats.depth, childStats.depth);
                });
            }
            
            return stats;
        }

        function renderJsonTree(data, container, searchTerm = '', path = '$') {
            container.innerHTML = '';
            const tree = createTreeNode(data, '', searchTerm, path);
            container.appendChild(tree);
        }

        function createTreeNode(data, key, searchTerm, path) {
            const wrapper = document.createElement('div');
            wrapper.className = 'tree-line';

            const isObject = data !== null && typeof data === 'object';
            const isArray = Array.isArray(data);
            const hasChildren = isObject && Object.keys(data).length > 0;

            if (hasChildren) {
                wrapper.classList.add('tree-node');
                
                const toggle = document.createElement('div');
                toggle.className = 'tree-toggle inline-flex items-center gap-1 py-0.5';
                
                const arrow = document.createElement('span');
                arrow.className = 'arrow text-gray-500';
                arrow.textContent = 'â–¼';
                toggle.appendChild(arrow);

                if (key !== '') {
                    const keySpan = createKeySpan(key, searchTerm);
                    toggle.appendChild(keySpan);
                    toggle.appendChild(document.createTextNode(': '));
                }

                const bracket = document.createElement('span');
                bracket.className = 'json-bracket';
                bracket.textContent = isArray ? '[' : '{';
                toggle.appendChild(bracket);

                const count = document.createElement('span');
                count.className = 'text-gray-500 text-xs ml-1';
                count.textContent = `${Object.keys(data).length} ${isArray ? 'items' : 'keys'}`;
                toggle.appendChild(count);

                // Copy buttons
                const copyBtns = createCopyButtons(path, data);
                toggle.appendChild(copyBtns);

                toggle.addEventListener('click', (e) => {
                    if (!e.target.closest('.copy-btn')) {
                        wrapper.classList.toggle('collapsed');
                    }
                });

                wrapper.appendChild(toggle);

                const children = document.createElement('div');
                children.className = 'tree-children';

                const entries = Object.entries(data);
                entries.forEach(([k, v], index) => {
                    const childPath = isArray ? `${path}[${k}]` : `${path}.${k}`;
                    const childNode = createTreeNode(v, isArray ? k : k, searchTerm, childPath);
                    children.appendChild(childNode);
                });

                const closeBracket = document.createElement('div');
                closeBracket.className = 'json-bracket';
                closeBracket.textContent = isArray ? ']' : '}';
                children.appendChild(closeBracket);

                wrapper.appendChild(children);
            } else {
                const line = document.createElement('div');
                line.className = 'py-0.5 flex items-center gap-2';

                if (key !== '') {
                    const keySpan = createKeySpan(key, searchTerm);
                    line.appendChild(keySpan);
                    line.appendChild(document.createTextNode(': '));
                }

                const valueSpan = createValueSpan(data, searchTerm);
                line.appendChild(valueSpan);

                // Copy buttons for leaf nodes
                const copyBtns = createCopyButtons(path, data);
                line.appendChild(copyBtns);

                wrapper.appendChild(line);
            }

            return wrapper;
        }

        function createKeySpan(key, searchTerm) {
            const span = document.createElement('span');
            span.className = 'json-key';
            
            if (searchTerm && key.toLowerCase().includes(searchTerm.toLowerCase())) {
                span.innerHTML = `"${highlightText(key, searchTerm)}"`;
            } else {
                span.textContent = `"${key}"`;
            }
            
            return span;
        }

        function createValueSpan(value, searchTerm) {
            const span = document.createElement('span');
            
            if (value === null) {
                span.className = 'json-null';
                span.textContent = 'null';
            } else if (typeof value === 'boolean') {
                span.className = 'json-boolean';
                span.textContent = value.toString();
            } else if (typeof value === 'number') {
                span.className = 'json-number';
                span.textContent = value.toString();
            } else if (typeof value === 'string') {
                span.className = 'json-string';
                const displayValue = `"${value}"`;
                if (searchTerm && value.toLowerCase().includes(searchTerm.toLowerCase())) {
                    span.innerHTML = `"${highlightText(value, searchTerm)}"`;
                } else {
                    span.textContent = displayValue;
                }
            } else if (Array.isArray(value) && value.length === 0) {
                span.className = 'json-bracket';
                span.textContent = '[]';
            } else if (typeof value === 'object' && Object.keys(value).length === 0) {
                span.className = 'json-bracket';
                span.textContent = '{}';
            }
            
            return span;
        }

        function highlightText(text, searchTerm) {
            const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function createCopyButtons(path, value) {
            const container = document.createElement('span');
            container.className = 'copy-btn ml-2 flex items-center gap-1';

            const pathBtn = document.createElement('button');
            pathBtn.className = 'text-xs text-gray-500 hover:text-blue-400 px-1 rounded hover:bg-gray-700';
            pathBtn.textContent = 'path';
            pathBtn.title = 'Copy path';
            pathBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                copyToClipboard(path);
            });

            const valueBtn = document.createElement('button');
            valueBtn.className = 'text-xs text-gray-500 hover:text-green-400 px-1 rounded hover:bg-gray-700';
            valueBtn.textContent = 'value';
            valueBtn.title = 'Copy value';
            valueBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const valueToCopy = typeof value === 'object' ? JSON.stringify(value, null, 2) : String(value);
                copyToClipboard(valueToCopy);
            });

            container.appendChild(pathBtn);
            container.appendChild(valueBtn);
            return container;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!');
            });
        }

        function showToast(message) {
            toast.textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 2000);
        }

        function updateSearchCount() {
            const term = searchInput.value;
            if (!term) {
                searchCount.textContent = '';
                return;
            }
            const highlights = jsonTree.querySelectorAll('.highlight');
            searchCount.textContent = `${highlights.length} matches`;
        }

        let outputData = undefined;

        async function executeJsonata() {
            const expression = jsonataEditor.getValue().trim();
            
            if (!expression || !jsonData) {
                outputTree.innerHTML = '<span class="text-gray-500">Enter a JSONata expression to see results</span>';
                queryError.classList.add('hidden');
                outputData = undefined;
                return;
            }

            try {
                const expr = jsonata(expression);
                // JSONata evaluate() returns a Promise
                const result = await expr.evaluate(jsonData);
                outputData = result;
                queryError.classList.add('hidden');
                
                if (result === undefined) {
                    outputTree.innerHTML = '<span class="text-gray-500">No results (undefined)</span>';
                } else {
                    renderJsonTree(result, outputTree, '', '$');
                }
            } catch (err) {
                queryError.textContent = err.message;
                queryError.classList.remove('hidden');
                outputTree.innerHTML = '<span class="text-gray-500">Fix the query error to see results</span>';
                outputData = undefined;
            }
        }

        function getOutputData() {
            return outputData;
        }

        function downloadJson(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
